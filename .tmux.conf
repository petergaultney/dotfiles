
# Reduce delay after Escape key (default 500ms). Makes Escape feel instant in TUIs.
# Added for lemonaid scratch pane UX. Safe to remove if it causes issues with
# escape sequences or function keys - it's just a responsiveness tweak.
set-option -g escape-time 10

# shortcut keys
set-option -g prefix `
unbind-key C-b
bind-key F11 set-option -g prefix C-b
bind-key F12 set-option -g prefix `
bind-key ` last-window
bind-key h send-prefix

# Lemonaid: back to previous pane (works across sessions)
bind-key b run-shell ' \
    target=$(lemonaid tmux swap "#{session_name}" "#{pane_id}"); \
    if [ -n "$target" ]; then \
        tmux switch-client -t "$(echo "$target" | cut -d"|" -f2)"; \
    fi'

# Lemonaid: mark current pane's notifications as read
bind-key m run-shell -b 'lemonaid mark-read --tty "#{pane_tty}" >/dev/null 2>&1'
bind-key l run-shell 'lemonaid tmux scratch --height 15%'

# set-option -g default-command "reattach-to-user-namespace -l fish"  # no longer necessary with >= tmux 2.6
set-option -g default-shell "$HOME/.local/xonsh-env/xbin/xonsh"

set -g base-index 1
bind r source-file ~/.tmux.conf
set-option -wg allow-rename off  # allow apps to set pane title

set-option -g status on
set-option -g status-keys emacs
set-window-option -g mode-keys emacs
# set-window-option -g mode-mouse on # for old tmux
set-option -g mouse on # for newer tmux
set-window-option -g monitor-activity on
# set-option -g mouse-select-pane on
set-option -g history-limit 50000

set-option -g default-terminal "tmux-256color"
set-option -sa terminal-features ',xterm-256color:RGB'

# Extended keys support for CSI u sequences (e.g., Shift+Enter in Claude Code)
set -s extended-keys on
set -as terminal-features 'xterm*:extkeys'

# Workaround: tmux recognizes Shift+Enter but doesn't forward it properly.
# Manually send the CSI u sequence (ESC [ 1 3 ; 2 u) to the pane.
bind -n S-Enter send-keys -H 1b 5b 31 33 3b 32 75

# 2026-01-20: Debugging xonsh OSC 7 directory tracking with Claude Code
# pane_path (set by OSC 7) was empty - need to enable osc7 terminal feature
# See: https://github.com/tmux/tmux/issues/3098
set -as terminal-features 'xterm*:osc7'
set -g set-titles on

bind C-y paste-buffer
# bind C-w copy-selection
bind-key -T copy-mode [    send-keys -X begin-selection
bind-key -T copy-mode M-w  send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode ]    send-keys -X copy-selection

bind -n MouseDown1StatusLeft choose-tree -Zs  # makes it possible to click session

# Split panes. -h = side-by-side (vertical divider), -v = stacked (horizontal divider).
# Also enables the pane border status bar (see PANE MANAGEMENT and COLORS sections).
unbind %
bind | run-shell 'tmux split-window -h && tmux setw pane-border-status top'
bind - run-shell 'tmux split-window -v && tmux setw pane-border-status top'

set -g terminal-overrides 'xterm*:smcup@:rmcup@'

# ============================================================================
# PANE MANAGEMENT — "v" key table (emacs-style hydra)
# ============================================================================
#
# All pane operations live under: prefix + v + <key>
#
# Key flags cheat sheet:
#   -T <table>   Bind the key in a named key table (not the default prefix table).
#                 `switch-client -T <table>` enters that table; next keypress is
#                 looked up there, then tmux returns to the default table.
#   -r           Repeatable: after firing, stay in the key table for repeat-time
#                 ms so the same key (or others in the table) can be tapped again
#                 without re-pressing prefix+v. Like an emacs hydra.
#   -d           On swap-window: keep focus on the window *content* you were
#                 viewing, not on the position number it was at.
#   -s <src>     Source window/pane (for join-pane: which window to pull from).
#   -t <tgt>     Target window/pane. +1/-1 are relative to current window index.
#   -h           On join-pane: join side-by-side (vertical divider). Confusingly
#                 tmux calls this "horizontal" because the *split line* is horizontal.
#
# Quick reference:
#   prefix v o/n/r/i   Navigate panes: right/left/up/down (repeatable)
#   prefix v ←/→       Reorder windows: swap left/right (repeatable)
#   prefix v t          Toggle pane border status bar on/off
#   prefix v b          Break other pane out to its own window
#   prefix v h <1-9>    Join window N into current as right vertical split
#
# ============================================================================

# How long (ms) repeatable keys (-r) stay active after last keypress.
set-option -g repeat-time 600

# Enter the "v" key table.
bind-key v switch-client -T vtable

# --- Navigate panes (mirrors emacs config, repeatable) ---
bind-key -T vtable -r o select-pane -R    # right
bind-key -T vtable -r n select-pane -L    # left
bind-key -T vtable -r r select-pane -U    # up
bind-key -T vtable -r i select-pane -D    # down

# --- Reorder windows (repeatable) ---
# -d: follow the window content, not the position number.
bind-key -T vtable -r Left  swap-window -d -t -1
bind-key -T vtable -r Right swap-window -d -t +1

# --- Toggle border status bar (escape hatch for stale state) ---
bind-key -T vtable t if-shell '[ "$(tmux show -wv pane-border-status)" = "top" ]' 'setw pane-border-status off' 'setw pane-border-status top'

# --- Break other pane out to its own window ---
# Turns off the border status bar if only one pane remains afterward.
bind-key -T vtable b run-shell 'tmux break-pane && [ "$(tmux display -p "#{window_panes}")" -eq 1 ] && tmux setw pane-border-status off || true'

# --- Join pane from window N as right vertical split ---
# Enters a nested key table; next digit fires join-pane.
# -h: side-by-side layout.  -s N: pull from window N.
bind-key -T vtable h switch-client -T vtable-join-h

bind-key -T vtable-join-h 1 run-shell 'tmux join-pane -h -s 1 && tmux setw pane-border-status top'
bind-key -T vtable-join-h 2 run-shell 'tmux join-pane -h -s 2 && tmux setw pane-border-status top'
bind-key -T vtable-join-h 3 run-shell 'tmux join-pane -h -s 3 && tmux setw pane-border-status top'
bind-key -T vtable-join-h 4 run-shell 'tmux join-pane -h -s 4 && tmux setw pane-border-status top'
bind-key -T vtable-join-h 5 run-shell 'tmux join-pane -h -s 5 && tmux setw pane-border-status top'
bind-key -T vtable-join-h 6 run-shell 'tmux join-pane -h -s 6 && tmux setw pane-border-status top'
bind-key -T vtable-join-h 7 run-shell 'tmux join-pane -h -s 7 && tmux setw pane-border-status top'
bind-key -T vtable-join-h 8 run-shell 'tmux join-pane -h -s 8 && tmux setw pane-border-status top'
bind-key -T vtable-join-h 9 run-shell 'tmux join-pane -h -s 9 && tmux setw pane-border-status top'

# ============================================================================
# END PANE MANAGEMENT
# ============================================================================

if-shell 'test "$(uname -s)" = "Darwin"' 'bind-key y run-shell "tmux show-buffer | pbcopy" \; display-message "Copied tmux buffer to system clipboard"'
if-shell 'test "$(uname -s)" = "Linux"' 'bind-key y run-shell "tmux show-buffer | xclip -sel clip -i" \; display-message "Copied tmux buffer to system clipboard"'
# COLORS

# https://www.ditig.com/256-colors-cheat-sheet

# ----------------------------------------------------------------------------
# Pane borders & active pane indicator
# ----------------------------------------------------------------------------
# Bright orange active border + dim inactive = easy to spot which pane has focus.
# pane-border-status adds a full-width bar at the top of each pane showing the
# running command. Costs one row of height per pane, but only appears when
# there are multiple panes in the window.
# ----------------------------------------------------------------------------
set -g pane-active-border-style "fg=colour208"
set -g pane-border-style "fg=colour236"
set -g pane-border-status off
set -g pane-border-format "#{?pane_active,#[bg=colour208 fg=colour0 bold] #T ,#[bg=colour236 fg=colour244] #T }"


## Status bar design
# status line
# set -g status-utf8 on
set -g status-justify left
set -g status-bg default
set -g status-fg colour12
set -g status-interval 1

# messaging
set -g message-style fg=black
set -g message-style bg=red
set -g message-command-style fg=blue
set -g message-command-style bg=black

# selection highlight (choose-tree, copy-mode)
set -g mode-style "bg=colour238,fg=colour231"

# window status - uses lemonaid-tmux-window-status for colored directory/process display
# Pass both #{pane_path} (OSC 7, for xonsh) and #{pane_current_path} (process, for fish/bash)
setw -g window-status-format " #I:#(lemonaid-tmux-window-status '#{pane_path}' '#{pane_current_path}' '#{pane_current_command}' '#{pane_title}' '#{window_active}') "
setw -g window-status-current-format " #I:#(lemonaid-tmux-window-status '#{pane_path}' '#{pane_current_path}' '#{pane_current_command}' '#{pane_title}' '#{window_active}') "
setw -g window-status-style none
setw -g window-status-current-style "bg=colour238"
setw -g window-status-activity-style none
setw -g window-status-separator "│"

# The statusbar {

set -g status-position bottom
set -g status-style bg=colour234
set -g status-style fg="colour137"
set -g status-left '#(lemonaid-tmux-session-name "#{session_name}")'
set -g status-right '#[fg=colour233,bg=colour241,bold] %d/%m #[fg=colour233,bg=colour255,bold] %H:%M:%S '
set -g status-right-length 50
set -g status-left-length 20

# }
